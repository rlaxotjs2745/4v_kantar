<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTO Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kantar.mapper.StatisticsMapper">
    <select id="getFileCount" resultType="long">
        SELECT count(1) FROM KT_FILE_STATISTICS
    </select>

    <select id="getAllFileWordCnt" resultType="long">
        SELECT sum(word_length) FROM KT_FILE_STATISTICS
    </select>

    <select id="getAllFileSize" resultType="Double">
        SELECT sum(file_size) FROM KT_FILE_STATISTICS
    </select>

    <select id="getReportCount" resultType="long">
        SELECT sum(report_cnt) FROM KT_FILE_STATISTICS
    </select>

    <insert id="setProjectStatistics" parameterType="com.kantar.vo.StatisticsVO">
        INSERT INTO KT_FILE_STATISTICS (file_status, idx_project, idx_user, file_cnt, file_size, word_length, report_cnt) VALUES (1, #{idx_project}, #{idx_user}, #{file_cnt}, #{file_size}, #{word_length}, 1)
    </insert>

    <update id="updateProjectReporteCnt" parameterType="com.kantar.vo.ProjectVO">
        UPDATE KT_FILE_STATISTICS
        SET report_cnt = report_cnt + 1,
            update_dt = now()
        WHERE idx_project = #{idx_project}
    </update>

    <update id="deleteProjectStatistics" parameterType="com.kantar.vo.ProjectVO">
        UPDATE KT_FILE_STATISTICS
        SET file_status = 99,
            update_dt = now()
        WHERE idx_project = #{idx_project}
    </update>

    <select id="getReportAPIUsage" resultType="Integer">
        SELECT count(1) FROM KT_API_STATISTICS WHERE idx_report = #{idx_report}
    </select>

    <insert id="setSummaryAPIUsage" parameterType="com.kantar.vo.StatisticsVO">
        INSERT INTO KT_API_STATISTICS (report_status, idx_report, idx_user, summaryUsage, keywordUsage)  VALUES (1, #{idx_report}, #{idx_user}, #{summaryUsage}, #{keywordUsage})
    </insert>

    <insert id="setKeywordAPIUsage" parameterType="com.kantar.vo.StatisticsVO">
        INSERT INTO KT_API_STATISTICS (report_status, idx_report, idx_user, summaryUsage, keywordUsage) VALUES (1, #{idx_report}, #{idx_user}, #{summaryUsage}, #{keywordUsage})
    </insert>

    <update id="updateSummaryAPIUsage" parameterType="com.kantar.vo.ProjectVO">
        UPDATE KT_API_STATISTICS
        SET summaryUsage = summaryUsage + #{summaryUsage},
            update_dt = now()
        WHERE idx_report = #{idx_report}
    </update>

    <update id="updateKeywordAPIUsage" parameterType="com.kantar.vo.ProjectVO">
        UPDATE KT_API_STATISTICS
        SET keywordUsage = keywordUsage + #{keywordUsage},
            update_dt = now()
        WHERE idx_report = #{idx_report}
    </update>

    <select id="getPjIdxToReport" resultType="com.kantar.vo.ProjectVO">
        SELECT idx_project
        FROM KT_REPORT
        WHERE idx_report = #{idx_report}
    </select>

    <update id="setSummaryAPIUsageAdd" parameterType="com.kantar.vo.ProjectVO">
        INSERT INTO KT_API_STATISTICS (report_status, idx_report, idx_user, summaryUsage, keywordUsage)  VALUES (2, #{idx_report}, #{idx_user}, #{summaryUsage}, #{keywordUsage})
    </update>

    <update id="setKeywordAPIUsageAdd" parameterType="com.kantar.vo.ProjectVO">
        INSERT INTO KT_API_STATISTICS (report_status, idx_report, idx_user, summaryUsage, keywordUsage) VALUES (2, #{idx_report}, #{idx_user}, #{summaryUsage}, #{keywordUsage})
    </update>

    <select id="getApiStatisticsByUser" resultType="long">
        SELECT NVL(sum(summaryUsage),0) as summaryUsage
        FROM KT_API_STATISTICS
        WHERE report_status != 99
        <if test="idx_user != null">
            AND idx_user = #{idx_user}
        </if>
        <if test="startDate != null">
            AND create_dt <![CDATA[>=]]> date_format(#{startDate}, '%Y-%m-%d')
        </if>
        <if test="endDate != null">
            AND create_dt <![CDATA[<]]> date_format(date_add(#{endDate}, INTERVAL 1 DAY), '%Y-%m-%d')
        </if>
    </select>

    <select id="getApiDataByUser" resultType="Double">
        SELECT NVL(ROUND(SUM(data_length + index_length) / 1024 / 1024, 3),0) AS dataUsage
        FROM information_schema.tables A, KT_REPORT B, KT_API_STATISTICS C
        WHERE (A.table_name = 'KT_REPORT' OR A.table_name = 'KT_REPORT_DATA')
          AND C.idx_report = B.idx_report
        <if test="idx_user != null">
          AND B.idx_user = #{idx_user}
        </if>
        <if test="startDate != null">
            AND C.create_dt <![CDATA[>=]]> date_format(#{startDate}, '%Y-%m-%d')
        </if>
        <if test="endDate != null">
            AND C.create_dt <![CDATA[<]]> date_format(date_add(#{endDate}, INTERVAL 1 DAY), '%Y-%m-%d')
        </if>
    </select>

</mapper>