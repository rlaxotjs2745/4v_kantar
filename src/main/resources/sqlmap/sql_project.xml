<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTO Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kantar.mapper.ProjectMapper">
    <select id="getProjectInfo" resultType="com.kantar.vo.ProjectVO">
        SELECT * FROM KT_PROJECT
    </select>

    <resultMap id="getProjectListMap" type="com.kantar.vo.ProjectListVO">
        <id property="idx_project" column="idx_project" />
        <result property="idx_project_job" column="idx_project_job" />
        <result property="idx_project_job_projectid" column="idx_project_job_projectid" />
        <result property="idx_report" column="idx_report" />
        <result property="job_no" column="job_no" />
        <result property="project_id" column="project_id" />
        <result property="project_name" column="project_name" />
        <result property="project_type" column="project_type" />
        <result property="project_status" column="project_status" />
        <result property="project_type_str" column="project_type_str" />
        <result property="title" column="title" />
        <result property="filename" column="filename" />
        <result property="user_name" column="user_name" />
        <result property="create_dt" column="create_dt" />
        <result property="doc_version" column="DOC_VERSION" />
        <collection property="reportList" resultMap="reportList"/>
    </resultMap>

    <resultMap id="reportList" type="com.kantar.vo.ReportListVO">
        <id column="idx_report" property="idx_report"/>
        <result column="keyword" property="keyword"/>
        <result column="keytype" property="keytype"/>
        <result column="keycount" property="keycount"/>
    </resultMap>

    <select id="getProjectList" resultMap="getProjectListMap">
        SELECT A.idx_project_job_projectid, B.job_no, A.project_id, D.filename, C.user_name, D.idx_report, E.project_name, IF(E.project_type=1, 'RAW DATA', '병합') AS project_type_str, E.idx_project, LEFT(REPLACE(E.create_dt,'-','.'),16) AS create_dt
        FROM KT_PROJECT_JOB_PROJECTID A
        JOIN KT_PROJECT_JOB B ON B.idx_project_job=A.idx_project_job
        JOIN KT_PROJECT E ON E.idx_project_job_projectid=A.idx_project_job_projectid
        JOIN KT_USER C ON C.idx_user=A.idx_user
        JOIN KT_REPORT D ON D.idx_project_job_projectid=A.idx_project_job_projectid
        ORDER BY A.project_id DESC
    </select>

    <select id="getProjectListCount" resultType="Integer">
        SELECT COUNT(1)
        FROM KT_PROJECT_JOB_PROJECTID A
        JOIN KT_PROJECT_JOB B ON B.idx_project_job=A.idx_project_job
        JOIN KT_PROJECT E ON E.idx_project_job_projectid=A.idx_project_job_projectid
    </select>

    <select id="getProjectJobNo" resultType="com.kantar.vo.ProjectVO">
        SELECT idx_project_job FROM KT_PROJECT_JOB WHERE job_no=#{job_no}
    </select>

    <insert id="savProjectJobNo" useGeneratedKeys="true" keyProperty="idx_project_job">
        INSERT INTO KT_PROJECT_JOB (job_no) VALUES (#{job_no})
    </insert>

    <select id="getProjectSeq" resultType="int">
        SELECT IFNULL(MAX(project_seq),0) FROM KT_PROJECT_JOB_PROJECTID
    </select>

    <insert id="savProjectJobProjectid" useGeneratedKeys="true" keyProperty="idx_project_job_projectid">
        INSERT INTO KT_PROJECT_JOB_PROJECTID (idx_project_job, project_id, project_seq, idx_user) VALUES (#{idx_project_job}, #{project_id}, #{project_seq}, #{idx_user});
    </insert>

    <insert id="savProjectInfo" useGeneratedKeys="true" keyProperty="idx_project">
        INSERT INTO KT_PROJECT (idx_project_job_projectid, project_name, project_type, project_status, summary0, idx_user) VALUES (#{idx_project_job_projectid}, #{project_name}, 1, 1, #{summary0}, #{idx_user});
    </insert>

    <update id="modiProjectInfo">
        UPDATE KT_PROJECT
            SET idx_user=#{idx_user}

            WHERE idx_project=#{idx_project}
    </update>

    <select id="getProjectView" resultType="com.kantar.vo.ProjectVO">
        SELECT A.idx_project_job_projectid, B.project_name, B.project_type, B.project_status, C.project_id, A.create_dt, B.summary0
        FROM KT_REPORT A
        JOIN KT_PROJECT B ON B.idx_project_job_projectid=A.idx_project_job_projectid
        JOIN KT_PROJECT_JOB_PROJECTID C ON C.idx_project_job_projectid=B.idx_project_job_projectid
        JOIN KT_PROJECT_JOB D ON D.idx_project_job=C.idx_project_job
        WHERE A.idx_report=#{idx}
    </select>

    <select id="getReportList" resultType="com.kantar.vo.ReportListVO">
        SELECT A.idx_report, B.job_no, A.report_id, A.title, LEFT(REPLACE(A.create_dt,'-','.'),16) AS create_dt, IF((A.d_count_total-A.d_count)=0,'생성완료','생성중') AS status_str
        FROM KT_REPORT A
        JOIN KT_PROJECT_JOB_PROJECTID D ON D.idx_project_job_projectid=A.idx_project_job_projectid
        JOIN KT_PROJECT_JOB B ON B.idx_project_job=D.idx_project_job
        ORDER BY A.idx_report DESC
    </select>

    <select id="getReportView" resultType="com.kantar.vo.ProjectVO">
        SELECT A.title, B.summary0, LEFT(REPLACE(B.create_dt,'-','.'),16) AS create_dt, B.idx_report_data, A.idx_report
        FROM KT_REPORT A
        JOIN KT_REPORT_DATA B ON B.idx_report=A.idx_report
        WHERE A.idx_report=#{idx}
    </select>

    <select id="getReportFileList" resultType="com.kantar.vo.ProjectVO">
        SELECT filepath, `filename` FROM KT_REPORT WHERE idx_project_job_projectid=#{idx_project_job_projectid}
    </select>

    <select id="getReportSeq" resultType="Integer">
        SELECT MAX(report_seq) AS report_seq FROM KT_REPORT
    </select>

    <insert id="savReport" useGeneratedKeys="true" keyProperty="idx_report">
		INSERT INTO KT_REPORT (idx_project, idx_project_job_projectid, report_seq, report_id, title, filepath, `filename`, idx_user) VALUES (#{idx_project}, #{idx_project_job_projectid}, #{report_seq}, #{report_id}, #{title}, #{filepath}, #{filename}, #{idx_user})
    </insert>

    <select id="getReportIdx" resultType="com.kantar.vo.ProjectVO">
        SELECT idx_report FROM KT_REPORT WHERE idx_project_job_projectid=#{idx_project_job_projectid}
    </select>

    <insert id="savReportIdx" useGeneratedKeys="true" keyProperty="idx_report">
        INSERT INTO KT_REPORT (idx_project, idx_project_job_projectid, idx_user) VALUES (#{idx_project}, #{idx_project_job_projectid}, #{idx_user})
    </insert>

    <insert id="saveReportData">
        INSERT INTO KT_REPORT_DATA (idx_report, summary0, idx_user) VALUES (#{idx_report}, #{summary0}, #{idx_user})
    </insert>

    <update id="modiReportData">
        UPDATE KT_REPORT
            SET idx=#{idx_user}
            <if test="title != null">
            , title=#{title}
            </if>
            <if test="summary0 != null">
            , summary0=#{summary0}
            </if>
            WHERE idx_report_data=#{idx_report_data}
    </update>

    <update id="comProject">
        UPDATE KT_PROJECT
            SET project_type=#{project_type},
            project_status=#{project_status}
            WHERE idx_project=#{idx_project}
    </update>

    <select id="getReportFilterList" resultType="com.kantar.vo.ReportFilterVO">
        SELECT idx_report_filter, filter_title FROM KT_REPORT_FILTER
    </select>
</mapper>